# OKR Backend — Краткое описание и структура

## Архитектура
- **Node.js + TypeScript + Express** — серверная логика
- **Prisma + PostgreSQL** — работа с БД
- **JWT** — аутентификация
- **Роли:**
  - `USER` — обычный пользователь, может редактировать только свои OKR
  - `ADMIN` — администратор, может удалять пользователей

## Основные сущности
- **User** — пользователь (email, пароль, имя, фамилия, роль)
- **OKR** — набор целей пользователя на период (год/квартал)
- **Goal** — цель внутри OKR (с ключевыми инициативами)
- **KeyResult** — ключевой результат цели (метрика, база, план, формула, факт)
- **WeeklyMonitoringEntry** — значения по неделям для KR

## Основные эндпоинты
### Аутентификация
- `POST /auth/register` — регистрация
- `POST /auth/login` — вход

### Пользователь
- `GET /user/me` — свой профиль
- `GET /user/all` — все пользователи
- `DELETE /user/:userId` — удалить пользователя (admin)

### OKR
- `GET /okr` — свои OKR (с целями, KR, monitoring, fact)
- `POST /okr` — создать OKR
- `PUT /okr/:id` — обновить OKR
- `POST /okr/:id/archive` — архивировать OKR
- `GET /okr/user/:userId` — OKR другого пользователя (только чтение)
- `GET /okr/dictionaries` — справочники формул и метрик

### Цели (Goal)
- `POST /okr/:okrId/goal` — добавить цель
- `PUT /okr/:okrId/goal/:goalId` — обновить цель
- `DELETE /okr/:okrId/goal/:goalId` — удалить цель

### Ключевые результаты (KeyResult)
- `POST /okr/goal/:goalId/keyresult` — добавить KR
- `PUT /okr/goal/:goalId/keyresult/:krId` — обновить KR
- `DELETE /okr/goal/:goalId/keyresult/:krId` — удалить KR

### Недельный мониторинг
- `POST /okr/keyresult/:krId/monitoring` — добавить/обновить значение за неделю
- `GET /okr/keyresult/:krId/monitoring` — получить значения по неделям

## Важные моменты
- Все защищённые эндпоинты требуют JWT в заголовке: `Authorization: Bearer <token>`
- Пользователь может редактировать только свои OKR, цели и KR
- Администратор может удалять пользователей
- Значение "факт" для KR вычисляется на лету по формуле и данным недельного мониторинга
- Ключевые инициативы (комментарии) хранятся на уровне цели и поддерживают многострочный текст
- Справочники формул и метрик доступны по `/okr/dictionaries` 

## Важные моменты (2025)
- Все новые функции (дублирование, reorder, drag-and-drop, undo, архивирование, автосохранение, прогресс-бары, подсказки, оптимизация запросов) реализованы и на backend, и на frontend.
- Эндпоинты backend поддерживают все действия, которые доступны во frontend.
- Для интеграции с frontend используются axios и react-query (TanStack Query).
- Все ошибки возвращаются в формате `{ error: '...' }` (глобальный ErrorHandler).
- Undo реализовано через повторное создание удалённого элемента с прежними данными.
- Drag-and-drop реализован через react-beautiful-dnd (или dnd-kit), порядок сохраняется через поля `order` и специальные эндпоинты.
- Архивированные OKR доступны только для чтения (редактирование, drag-and-drop, дублирование отключены).
- Прогресс-бары цветные и анимированные, подсказки (Tooltip) для всех ключевых элементов.
- Все новые функции сразу тестируются на интеграцию backend + frontend.

## Новые эндпоинты (2025)
### Дублирование
- `POST /okr/:id/duplicate` — дублирует OKR вместе с целями и KR
- `POST /okr/goal/:goalId/duplicate` — дублирует цель вместе с KR
- `POST /okr/goal/:goalId/keyresult/:krId/duplicate` — дублирует KR

### Drag-and-drop (смена порядка)
- `POST /okr/:id/reorder-goals` — меняет порядок целей внутри OKR (body: `{ goalIds: string[] }`)
- `POST /okr/goal/:goalId/reorder-keyresults` — меняет порядок KR внутри цели (body: `{ krIds: string[] }`)

### Архивирование
- `POST /okr/:id/archive` — архивирует OKR (только для владельца)

### Undo (отмена удаления)
- Реализовано через повторное создание элемента с прежними данными (используются стандартные POST-эндпоинты для целей/KR)

### Глобальная обработка ошибок
- Все ошибки возвращаются в формате `{ error: '...' }`

### Оптимизация запросов
- Используется react-query (TanStack Query) для кэширования, автоматического обновления и оптимистичных обновлений на фронте.

## Прочее
- Все новые функции реализуются параллельно на backend и frontend.
- Если появляется новая бизнес-логика — сначала реализуется эндпоинт, затем интеграция с UI.
- Для тестирования и отладки удобно использовать Postman/Insomnia и react-query Devtools. 